name: Run Login Script

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 */5 * *"  # æ¯5å¤©è¿è¡Œä¸€æ¬¡
  push:
    branches:
      - main

permissions:
  contents: write  # å¿…é¡»æ·»åŠ è¿™ä¸ªæƒé™ï¼Œå¦åˆ™ GITHUB_TOKEN æ— æ³•æ¨é€åˆ°ä»“åº“

jobs:
  login:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ä»“åº“ä»£ç 
        uses: actions/checkout@v2
        
      - name: å®‰è£… Playwright æ‰€éœ€ä¾èµ–
        run: |
          npx playwright install-deps

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v2
        with:
          python-version: '3.10'

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install playwright aiofiles requests

      - name: Install Playwright Browsers  # å®‰è£…æµè§ˆå™¨
        run: |
          playwright install
          
      - name: Set up WARP
        uses: fscarmen/warp-on-actions@v1.3
        with:
           stack: dual        # Optional. Support [ ipv4, ipv6, dual ]. Default is dual.
           mode: client    # Optional. Support [ wireguard, client ]. Default is wireguard.

      - name: è¿è¡Œç™»å½•è„šæœ¬
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          WEBHOST: ${{ secrets.WEBHOST }}
        run: |
          python login_script.py

      # --- æ–°å¢çš„é˜²æš‚åœä»£ç å¼€å§‹ ---
      - name: Commit time.txt to repo
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # å¦‚æœ time.txt ä¸å­˜åœ¨ï¼Œè¯´æ˜æ˜¯ç¬¬ä¸€æ¬¡è¿è¡Œ
          if [ ! -f time.txt ]; then
            echo "é¦–æ¬¡ç”Ÿæˆæ—¶é—´ï¼š$(date +'%Y-%m-%d %H:%M:%S')" > time.txt
          else
            echo "$(date +'%Y-%m-%d %H:%M:%S')" > time.txt
          fi

          git add time.txt

          # å¦‚æœæœ‰æ›´æ”¹å†æäº¤
          if git diff --cached --quiet; then
            echo "æ— å˜åŒ–ï¼Œæ— éœ€æäº¤"
          else
            git commit -m "ğŸ¤– æ›´æ–°æ—¶é—´æ–‡ä»¶: $(date +'%Y-%m-%d %H:%M:%S')"
            git push origin HEAD:main
          fi
      # --- æ–°å¢çš„é˜²æš‚åœä»£ç ç»“æŸ ---
